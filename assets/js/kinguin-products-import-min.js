class ImportProducts{constructor(){this.setupContainer=document.getElementById("kinguin-import-setup"),this.importButton=this.setupContainer.querySelector(".start-import"),this.importButton.onclick=()=>this.createCacheDir(),this.ajaxUrl=kinguin.ajax_url,this.totalPages=parseInt(kinguin.total),this.progress=0,this.progressCacheProductsUpdate=!1,this.progressImportProductsUpdate=!1,this.cachedFiles=kinguin.cachedFiles,this.importIsRunning=!1}createCacheDir(){let t=this;jQuery.ajax({type:"POST",url:t.ajaxUrl,dataType:"json",tryCount:0,retryLimit:3,async:!0,data:{action:"set_cache"},beforeSend:function(){t.setupContainer.querySelector(".import-setup__begin").style.display="none",t.setupContainer.querySelector(".import-setup__process").style.display="block",t.importButton.disabled=!0},error:function(t,e,r){if("timeout"==e)return this.tryCount++,this.tryCount<=this.retryLimit?void jQuery.ajax(this):void 0}}).done((function(e){let r=t.setupContainer.querySelector(".status_cache_dir");r.innerHTML="Done",r.classList.add("success"),t.cacheProducts(kinguin.page)}))}cacheProducts(t){let e=this;jQuery.ajax({type:"POST",url:e.ajaxUrl,dataType:"json",tryCount:0,retryLimit:3,async:!0,data:{action:"import_products_to_cache",page:t},error:function(t,e,r){if("timeout"==e)return this.tryCount++,this.tryCount<=this.retryLimit?void jQuery.ajax(this):void 0}}).done((function(r){if(!0===r.success){let s=e.setupContainer.querySelector(".status_cache");e.totalPages=r.data.of,e.cachedFiles.push(r.data.file),t>1&&0==e.progressCacheProductsUpdate?(e.progress=parseInt(t),e.progressCacheProductsUpdate=!0):e.progress++,e.setProgressBar(),s.innerHTML=t+" of "+e.totalPages,t<e.totalPages&&e.cacheProducts(parseInt(t)+1),!1===e.importIsRunning&&e.importProducts(),t==e.totalPages&&(s.classList.add("success"),s.innerHTML="Done")}}))}importProducts(){let t=this;t.cachedFiles.length>0&&jQuery.ajax({type:"POST",url:t.ajaxUrl,dataType:"json",tryCount:0,retryLimit:3,data:{action:"import_products_to_woocommerce",file:t.cachedFiles[0],total_pages:t.totalPages},beforeSend:function(){t.importIsRunning=!0},error:function(e,r,s){if(t.importIsRunning=!1,"timeout"===r)return this.tryCount++,this.tryCount<=this.retryLimit?void jQuery.ajax(this):void 0}}).done((function(e){if(!0===e.success){let r=t.setupContainer.querySelector(".status_import");parseInt(e.data.page)>1&&0==t.progressImportProductsUpdate?(t.progress=t.progress+parseInt(e.data.page),t.progressImportProductsUpdate=!0):t.progress++,t.setProgressBar(),r.innerHTML=e.data.page+" of "+t.totalPages,t.cachedFiles.shift(),t.importProducts(),e.data.page===t.totalPages&&(r.classList.add("success"),r.innerHTML="Done",t.setupContainer.querySelector(".import-setup__process").style.display="none",t.setupContainer.querySelector(".import-setup__done").style.display="block")}}))}setProgressBar(){let t=this.setupContainer.querySelector("#import-progress");t.max=2*parseInt(this.totalPages),t.value=parseInt(this.progress)}}new ImportProducts;